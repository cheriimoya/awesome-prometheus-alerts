groups:

- name: EmbeddedExporter

  rules:

    - alert: VaultSealed
      expr: 'vault_core_unsealed == 0'
      for: 0m
      labels:
        severity: critical
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: Vault sealed"
        description: "Vault instance is sealed on {{ $labels.instance }}\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

    - alert: VaultTooManyPendingTokens
      expr: 'avg(vault_token_create_count - vault_token_store_count) > 0'
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: Vault too many pending tokens"
        description: "Too many pending tokens {{ $labels.instance }}: {{ $value | printf \"%.2f\"}}%\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

    - alert: VaultTooManyInfinityTokens
      expr: 'vault_token_count_by_ttl{creation_ttl="+Inf"} > 3'
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: Vault too many infinity tokens"
        description: "Too many infinity tokens {{ $labels.instance }}: {{ $value | printf \"%.2f\"}}%\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

    - alert: VaultClusterHealth
      expr: 'sum(vault_core_active) / count(vault_core_active) <= 0.5'
      for: 0m
      labels:
        severity: critical
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: Vault cluster health"
        description: "Vault cluster is not healthy {{ $labels.instance }}: {{ $value | printf \"%.2f\"}}%\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

