groups:

- name: ConsulExporter

  rules:

    - alert: ConsulServiceHealthcheckFailed
      expr: 'consul_catalog_service_node_healthy == 0'
      for: 1m
      labels:
        severity: critical
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: Consul service healthcheck failed"
        description: "Service: `{{ $labels.service_name }}` Healthcheck: `{{ $labels.service_id }}`\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

    - alert: ConsulMissingMasterNode
      expr: 'consul_raft_peers < 3'
      for: 0m
      labels:
        severity: critical
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: Consul missing master node"
        description: "Numbers of consul raft peers should be 3, in order to preserve quorum.\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

    - alert: ConsulAgentUnhealthy
      expr: 'consul_health_node_status{status="critical"} == 1'
      for: 0m
      labels:
        severity: critical
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: Consul agent unhealthy"
        description: "A Consul agent is down\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

