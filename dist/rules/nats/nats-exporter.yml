groups:

- name: NatsExporter

  rules:

    - alert: NatsHighConnectionCount
      expr: 'gnatsd_varz_connections > 100'
      for: 3m
      labels:
        severity: warning
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: Nats high connection count"
        description: "High number of NATS connections ({{ $value }}) for {{ $labels.instance }}\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

    - alert: NatsHighSubscriptionsCount
      expr: 'gnatsd_connz_subscriptions > 50'
      for: 3m
      labels:
        severity: warning
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: Nats high subscriptions count"
        description: "High number of NATS subscriptions ({{ $value }}) for {{ $labels.instance }}\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

    - alert: NatsHighRoutesCount
      expr: 'gnatsd_varz_routes > 10'
      for: 3m
      labels:
        severity: warning
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: Nats high routes count"
        description: "High number of NATS routes ({{ $value }}) for {{ $labels.instance }}\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

    - alert: NatsHighMemoryUsage
      expr: 'gnatsd_varz_mem > 200 * 1024 * 1024'
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: Nats high memory usage"
        description: "NATS server memory usage is above 200MB for {{ $labels.instance }}\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

    - alert: NatsSlowConsumers
      expr: 'gnatsd_varz_slow_consumers > 0'
      for: 3m
      labels:
        severity: critical
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: Nats slow consumers"
        description: "There are slow consumers in NATS for {{ $labels.instance }}\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

    - alert: NatsServerDown
      expr: 'absent(up{job="nats"})'
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: Nats server down"
        description: "NATS server has been down for more than 5 minutes\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

    - alert: NatsHighCpuUsage
      expr: 'rate(gnatsd_varz_cpu[5m]) > 0.8'
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: Nats high CPU usage"
        description: "NATS server is using more than 80% CPU for the last 5 minutes\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

    - alert: NatsHighNumberOfConnections
      expr: 'gnatsd_connz_num_connections > 1000'
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: Nats high number of connections"
        description: "NATS server has more than 1000 active connections\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

    - alert: NatsHighJetstreamStoreUsage
      expr: 'gnatsd_varz_jetstream_stats_storage / gnatsd_varz_jetstream_config_max_storage > 0.8'
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: Nats high JetStream store usage"
        description: "JetStream store usage is over 80%\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

    - alert: NatsHighJetstreamMemoryUsage
      expr: 'gnatsd_varz_jetstream_stats_memory / gnatsd_varz_jetstream_config_max_memory > 0.8'
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: Nats high JetStream memory usage"
        description: "JetStream memory usage is over 80%\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

    - alert: NatsHighNumberOfSubscriptions
      expr: 'gnatsd_connz_subscriptions > 1000'
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: Nats high number of subscriptions"
        description: "NATS server has more than 1000 active subscriptions\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

    - alert: NatsHighPendingBytes
      expr: 'gnatsd_connz_pending_bytes > 100000'
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: Nats high pending bytes"
        description: "NATS server has more than 100,000 pending bytes\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

    - alert: NatsTooManyErrors
      expr: 'increase(gnatsd_varz_jetstream_stats_api_errors[5m]) > 0'
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: Nats too many errors"
        description: "NATS server has encountered errors in the last 5 minutes\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

    - alert: NatsJetstreamConsumersExceeded
      expr: 'sum(gnatsd_varz_jetstream_stats_accounts) > 100'
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: Nats JetStream consumers exceeded"
        description: "JetStream has more than 100 active consumers\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

    - alert: NatsFrequentAuthenticationTimeouts
      expr: 'increase(gnatsd_varz_auth_timeout[5m]) > 5'
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: Nats frequent authentication timeouts"
        description: "There have been more than 5 authentication timeouts in the last 5 minutes\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

    - alert: NatsMaxPayloadSizeExceeded
      expr: 'max(gnatsd_varz_max_payload) > 1024 * 1024'
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: Nats max payload size exceeded"
        description: "The max payload size allowed by NATS has been exceeded (1MB)\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

    - alert: NatsLeafNodeConnectionIssue
      expr: 'increase(gnatsd_varz_leafnodes[5m]) == 0'
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: Nats leaf node connection issue"
        description: "No leaf node connections have been established in the last 5 minutes\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

    - alert: NatsMaxPingOperationsExceeded
      expr: 'gnatsd_varz_ping_max > 50'
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: Nats max ping operations exceeded"
        description: "The maximum number of ping operations in NATS has exceeded 50\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

    - alert: NatsWriteDeadlineExceeded
      expr: 'gnatsd_varz_write_deadline > 10'
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: Nats write deadline exceeded"
        description: "The write deadline has been exceeded in NATS, indicating potential message delivery issues\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

