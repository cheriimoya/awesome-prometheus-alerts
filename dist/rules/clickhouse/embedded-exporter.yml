groups:

- name: EmbeddedExporter

  rules:

    - alert: ClickhouseMemoryUsageCritical
      expr: 'ClickHouseAsyncMetrics_CGroupMemoryUsed / ClickHouseAsyncMetrics_CGroupMemoryTotal * 100 > 90'
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: ClickHouse Memory Usage Critical"
        description: "Memory usage is critically high, over 90%.\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

    - alert: ClickhouseMemoryUsageWarning
      expr: 'ClickHouseAsyncMetrics_CGroupMemoryUsed / ClickHouseAsyncMetrics_CGroupMemoryTotal * 100 > 80'
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: ClickHouse Memory Usage Warning"
        description: "Memory usage is over 80%.\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

    - alert: ClickhouseDiskSpaceLowOnDefault
      expr: 'ClickHouseAsyncMetrics_DiskAvailable_default / (ClickHouseAsyncMetrics_DiskAvailable_default + ClickHouseAsyncMetrics_DiskUsed_default) * 100 < 20'
      for: 2m
      labels:
        severity: warning
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: ClickHouse Disk Space Low on Default"
        description: "Disk space on default is below 20%.\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

    - alert: ClickhouseDiskSpaceCriticalOnDefault
      expr: 'ClickHouseAsyncMetrics_DiskAvailable_default / (ClickHouseAsyncMetrics_DiskAvailable_default + ClickHouseAsyncMetrics_DiskUsed_default) * 100 < 10'
      for: 2m
      labels:
        severity: critical
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: ClickHouse Disk Space Critical on Default"
        description: "Disk space on default disk is critically low, below 10%.\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

    - alert: ClickhouseDiskSpaceLowOnBackups
      expr: 'ClickHouseAsyncMetrics_DiskAvailable_backups / (ClickHouseAsyncMetrics_DiskAvailable_backups + ClickHouseAsyncMetrics_DiskUsed_backups) * 100 < 20'
      for: 2m
      labels:
        severity: warning
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: ClickHouse Disk Space Low on Backups"
        description: "Disk space on backups is below 20%.\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

    - alert: ClickhouseReplicaErrors
      expr: 'ClickHouseErrorMetric_ALL_REPLICAS_ARE_STALE == 1 or ClickHouseErrorMetric_ALL_REPLICAS_LOST == 1'
      for: 0m
      labels:
        severity: critical
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: ClickHouse Replica Errors"
        description: "Critical replica errors detected, either all replicas are stale or lost.\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

    - alert: ClickhouseNoAvailableReplicas
      expr: 'ClickHouseErrorMetric_NO_AVAILABLE_REPLICA == 1'
      for: 0m
      labels:
        severity: critical
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: ClickHouse No Available Replicas"
        description: "No available replicas in ClickHouse.\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

    - alert: ClickhouseNoLiveReplicas
      expr: 'ClickHouseErrorMetric_TOO_FEW_LIVE_REPLICAS == 1'
      for: 0m
      labels:
        severity: critical
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: ClickHouse No Live Replicas"
        description: "There are too few live replicas available, risking data loss and service disruption.\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

    - alert: ClickhouseHighNetworkTraffic
      expr: 'ClickHouseMetrics_NetworkSend > 250 or ClickHouseMetrics_NetworkReceive > 250'
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: ClickHouse High Network Traffic"
        description: "Network traffic is unusually high, may affect cluster performance.\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

    - alert: ClickhouseHighTcpConnections
      expr: 'ClickHouseMetrics_TCPConnection > 400'
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: ClickHouse High TCP Connections"
        description: "High number of TCP connections, indicating heavy client or inter-cluster communication.\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

    - alert: ClickhouseInterserverConnectionIssues
      expr: 'increase(ClickHouseMetrics_InterserverConnection[5m]) > 0'
      for: 1m
      labels:
        severity: warning
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: ClickHouse Interserver Connection Issues"
        description: "An increase in interserver connections may indicate replication or distributed query handling issues.\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

    - alert: ClickhouseZookeeperConnectionIssues
      expr: 'avg(ClickHouseMetrics_ZooKeeperSession) != 1'
      for: 3m
      labels:
        severity: warning
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: ClickHouse ZooKeeper Connection Issues"
        description: "ClickHouse is experiencing issues with ZooKeeper connections, which may affect cluster state and coordination.\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

    - alert: ClickhouseAuthenticationFailures
      expr: 'increase(ClickHouseErrorMetric_AUTHENTICATION_FAILED[5m]) > 0'
      for: 0m
      labels:
        severity: info
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: ClickHouse Authentication Failures"
        description: "Authentication failures detected, indicating potential security issues or misconfiguration.\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

    - alert: ClickhouseAccessDeniedErrors
      expr: 'increase(ClickHouseErrorMetric_RESOURCE_ACCESS_DENIED[5m]) > 0'
      for: 0m
      labels:
        severity: info
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: ClickHouse Access Denied Errors"
        description: "Access denied errors have been logged, which could indicate permission issues or unauthorized access attempts.\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

