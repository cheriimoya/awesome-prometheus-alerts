groups:

- name: KbuddeRabbitmqExporter

  rules:

    - alert: RabbitmqDown
      expr: 'rabbitmq_up == 0'
      for: 0m
      labels:
        severity: critical
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: RabbitMQ down"
        description: "RabbitMQ node down\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

    - alert: RabbitmqClusterDown
      expr: 'sum(rabbitmq_running) < 3'
      for: 0m
      labels:
        severity: critical
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: RabbitMQ cluster down"
        description: "Less than 3 nodes running in RabbitMQ cluster\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

    - alert: RabbitmqClusterPartition
      expr: 'rabbitmq_partitions > 0'
      for: 0m
      labels:
        severity: critical
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: RabbitMQ cluster partition"
        description: "Cluster partition\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

    - alert: RabbitmqOutOfMemory
      expr: 'rabbitmq_node_mem_used / rabbitmq_node_mem_limit * 100 > 90'
      for: 2m
      labels:
        severity: warning
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: RabbitMQ out of memory"
        description: "Memory available for RabbmitMQ is low (< 10%)\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

    - alert: RabbitmqTooManyConnections
      expr: 'rabbitmq_connectionsTotal > 1000'
      for: 2m
      labels:
        severity: warning
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: RabbitMQ too many connections"
        description: "RabbitMQ instance has too many connections (> 1000)\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

    - alert: RabbitmqDeadLetterQueueFillingUp
      expr: 'rabbitmq_queue_messages{queue="my-dead-letter-queue"} > 10'
      for: 1m
      labels:
        severity: warning
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: RabbitMQ dead letter queue filling up"
        description: "Dead letter queue is filling up (> 10 msgs)\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

    - alert: RabbitmqTooManyMessagesInQueue
      expr: 'rabbitmq_queue_messages_ready{queue="my-queue"} > 1000'
      for: 2m
      labels:
        severity: warning
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: RabbitMQ too many messages in queue"
        description: "Queue is filling up (> 1000 msgs)\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

    - alert: RabbitmqSlowQueueConsuming
      expr: 'time() - rabbitmq_queue_head_message_timestamp{queue="my-queue"} > 60'
      for: 2m
      labels:
        severity: warning
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: RabbitMQ slow queue consuming"
        description: "Queue messages are consumed slowly (> 60s)\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

    - alert: RabbitmqNoConsumer
      expr: 'rabbitmq_queue_consumers == 0'
      for: 1m
      labels:
        severity: critical
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: RabbitMQ no consumer"
        description: "Queue has no consumer\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

    - alert: RabbitmqTooManyConsumers
      expr: 'rabbitmq_queue_consumers{queue="my-queue"} > 1'
      for: 0m
      labels:
        severity: critical
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: RabbitMQ too many consumers"
        description: "Queue should have only 1 consumer\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

    - alert: RabbitmqUnactiveExchange
      expr: 'rate(rabbitmq_exchange_messages_published_in_total{exchange="my-exchange"}[1m]) < 5'
      for: 2m
      labels:
        severity: warning
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: RabbitMQ unactive exchange"
        description: "Exchange receive less than 5 msgs per second\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

