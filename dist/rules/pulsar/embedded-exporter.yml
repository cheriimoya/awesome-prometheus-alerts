groups:

- name: EmbeddedExporter

  rules:

    - alert: PulsarSubscriptionHighNumberOfBacklogEntries
      expr: 'sum(pulsar_subscription_back_log) by (subscription) > 5000'
      for: 1h
      labels:
        severity: warning
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: Pulsar subscription high number of backlog entries"
        description: "The number of subscription backlog entries is over 5k\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

    - alert: PulsarSubscriptionVeryHighNumberOfBacklogEntries
      expr: 'sum(pulsar_subscription_back_log) by (subscription) > 100000'
      for: 1h
      labels:
        severity: critical
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: Pulsar subscription very high number of backlog entries"
        description: "The number of subscription backlog entries is over 100k\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

    - alert: PulsarTopicLargeBacklogStorageSize
      expr: 'sum(pulsar_storage_size > 5*1024*1024*1024) by (topic)'
      for: 1h
      labels:
        severity: warning
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: Pulsar topic large backlog storage size"
        description: "The topic backlog storage size is over 5 GB\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

    - alert: PulsarTopicVeryLargeBacklogStorageSize
      expr: 'sum(pulsar_storage_size > 20*1024*1024*1024) by (topic)'
      for: 1h
      labels:
        severity: critical
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: Pulsar topic very large backlog storage size"
        description: "The topic backlog storage size is over 20 GB\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

    - alert: PulsarHighWriteLatency
      expr: 'sum(pulsar_storage_write_latency_overflow > 0) by (topic)'
      for: 1h
      labels:
        severity: critical
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: Pulsar high write latency"
        description: "Messages cannot be written in a timely fashion\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

    - alert: PulsarLargeMessagePayload
      expr: 'sum(pulsar_entry_size_overflow > 0) by (topic)'
      for: 1h
      labels:
        severity: warning
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: Pulsar large message payload"
        description: "Observing large message payload (> 1MB)\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

    - alert: PulsarHighLedgerDiskUsage
      expr: 'sum(bookie_ledger_dir__pulsar_data_bookkeeper_ledgers_usage) by (kubernetes_pod_name) > 75'
      for: 1h
      labels:
        severity: critical
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: Pulsar high ledger disk usage"
        description: "Observing Ledger Disk Usage (> 75%)\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

    - alert: PulsarReadOnlyBookies
      expr: 'count(bookie_SERVER_STATUS{} == 0) by (pod)'
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: Pulsar read only bookies"
        description: "Observing Readonly Bookies\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

    - alert: PulsarHighNumberOfFunctionErrors
      expr: 'sum((rate(pulsar_function_user_exceptions_total{}[1m]) + rate(pulsar_function_system_exceptions_total{}[1m])) > 10) by (name)'
      for: 1m
      labels:
        severity: critical
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: Pulsar high number of function errors"
        description: "Observing more than 10 Function errors per minute\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

    - alert: PulsarHighNumberOfSinkErrors
      expr: 'sum(rate(pulsar_sink_sink_exceptions_total{}[1m]) > 10) by (name)'
      for: 1m
      labels:
        severity: critical
      annotations:
        summary: "{% if $labels.alias %}{{ $labels.alias }}{% else %}{{ $labels.instance }}: Pulsar high number of sink errors"
        description: "Observing more than 10 Sink errors per minute\nVALUE = {{ $value }}\n{{ range $k, $v := $labels }}{{ $k }}=\"{{ $v }}\" {{ end }}"

